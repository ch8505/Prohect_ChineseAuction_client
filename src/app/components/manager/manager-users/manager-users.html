<div class="page-container">
    <h1 class="page-title">ניהול <span class="highlight">רוכשים</span></h1>

    <div class="controls-container">
        <div class="controls-glass-card">
            
            <div class="search-section">
                <div class="input-glow-wrapper">
                    <i class="pi pi-search search-icon"></i>
                    <input type="text" pInputText placeholder="חפש לפי מזהה לקוח..." 
                           [(ngModel)]="searchTerm" (keyup)="filterCustomers()" 
                           class="modern-search" />
                </div>
            </div>

            <div class="actions-section">
                <p-button icon="pi pi-refresh" (click)="loadData()" [text]="true" class="premium-btn reset-btn"
                          pTooltip="רענן נתונים" tooltipPosition="bottom">
                </p-button>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <p-table [value]="filteredCustomers" class="p-datatable-striped" [tableStyle]="{'min-width': '60rem'}">
            <ng-template pTemplate="header">
                <tr>
                    <th>מזהה לקוח</th>
                    <th>שם לקוח</th>
                    <th>מס' הזמנות</th>
                    <th>סה"כ כרטיסים</th>
                    <th>סה"כ שולם</th>
                    <th>פעולות</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-customer>
                <tr>
                    <td>#{{customer.userId}}</td>
                    <td style="font-weight: bold; color: #cbd5e1;">{{customer.userName}}</td>
                    <td>{{customer.ordersCount}}</td>
                    <td><span class="qty-badge info">{{customer.totalItems}}</span></td>
                    <td style="color: var(--neon-cyan); font-family: monospace; font-size: 1.1em;">
                        {{customer.totalSpent | currency:'ILS'}}
                    </td>
                    <td>
                        <p-button label="פירוט רכישות" icon="pi pi-list" 
                                  styleClass="details-btn" 
                                  (click)="viewCustomerDetails(customer)">
                        </p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

@if (displayDialog && selectedCustomer) {
    <p-dialog [header]="'היסטוריית רכישות: ' + selectedCustomer.userName" 
              [(visible)]="displayDialog" 
              [modal]="true" 
              [style]="{ width: '50vw' }"
              [draggable]="false" 
              [resizable]="false"
              styleClass="glass-dialog">
        
        <div class="dialog-content">
            <div class="summary-box mb-3">
                <div class="summary-item">
                    <span>סה"כ שולם:</span>
                    <strong style="color: var(--neon-cyan)">{{ selectedCustomer.totalSpent | currency:'ILS' }}</strong>
                </div>
                <div class="summary-item">
                    <span>סה"כ כרטיסים:</span>
                    <strong>{{ selectedCustomer.totalItems }}</strong>
                </div>
            </div>

            <p-table [value]="selectedCustomer.allItems" 
                     styleClass="p-datatable-sm detail-table" 
                     [scrollable]="true" scrollHeight="400px">
                <ng-template pTemplate="header">
                    <tr>
                        <th>שם המתנה</th>
                        <th>מחיר יחידה</th>
                        <th>כמות כרטיסים</th>
                        <th>סה"כ</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-item>
                    <tr>
                        <td>{{item.giftName}}</td>
                        <td>{{item.unitPrice | currency:'ILS'}}</td>
                        <td><span class="qty-badge">{{item.quantity}}</span></td>
                        <td>{{(item.unitPrice * item.quantity) | currency:'ILS'}}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <ng-template pTemplate="footer">
            <p-button label="סגור" icon="pi pi-times" (click)="displayDialog = false" styleClass="p-button-text text-white"></p-button>
        </ng-template>
    </p-dialog>
}